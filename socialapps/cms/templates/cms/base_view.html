{% extends "base.html" %}
{% load i18n %}
{% load socialapps_tags %}
{% load courses_tags %}
{% load cms_tags %}

{% block extra_css %}
	<link rel="stylesheet" href="{{ STATIC_URL }}css/buttons.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/cms.css">
{% endblock %}

{% block extra_js %}
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.cleditor.extimage.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			
			$('.modal-confirm-button').click(function(e) {
				$('#cms-confirm-modal').find('.modal-footer form').attr('action', $(this).attr('data-content'));
			});
						
			$('.collapse').collapse();
			var startOrder = endOrder = "";
			$("#children-list").tableDnD({
				onDragClass: 'onDrag',
				dragHandle: 'move-child',
				onDrop: function(table, row) {
					endOrder = $.tableDnD.serialize().replace(/children-list\[\]+=/g, '').split('&');
					actualRow = row.id
					if( endOrder !== startOrder) {
						for (var i = 0; i < endOrder.length; i++) {
							if (endOrder[i] === actualRow) {
								object = actualRow;
								if ( i > 0 ) {
									target = endOrder[i-1]
									position = 'right';
								} else {
									target = endOrder[i+1]
									position = 'left';
								}
							}
						}
						$.post('{% url base_sort object.get_absolute_url %}', 
							{ 
								'object' 	: object, 
								'target' 	: target,
								'position'	: position
							}, function(data) {
								console.log(data);
						});					
					}
				},
				onDragStart: function(table, row) {
					startOrder = $.tableDnD.serialize().replace(/children-list\[\]+=/g, '').split('&');
				}
			});
		});
	</script>
	{% if object %}
		<script type="text/javascript">
			$.cleditor.buttons.image.uploadUrl = '{% url base_create object.get_absolute_url "image" %}';
			$.cleditor.buttons.image.popupContent =	
				'<ul class="browser-tabs nav tabs">' +
					'<li><a href="#url" data-toggle="tab">{% trans "Url from a external image" %}</a></li>' +				
					'<li><a href="#upload" data-toggle="tab">{% trans "Upload from your computer" %}</a></li>' +
					'<li><a href="#existing" data-toggle="tab">{% trans "Choose an existing one" %}</a></li>' +					
				'</ul>' +
				'<div class="tab-content">'+
					'<div id="url" class="tab-pane fade">' +
						'<input type="text" class="url" size="40" value="" />' +				
					'</div>' +
					'<div id="upload" class="tab-pane fade"><iframe style="width:0;height:0;border:0;" name="__upload_iframe" />' +
						'<form method="post" enctype="multipart/form-data" action="" target="__upload_iframe">' +
						"{% csrf_token %}" + 			
						'<input id="id_image" name="image" type="file" /></form>' +
					'</div>' +
					'<div class="tab-pane fade" id="existing">' +
						'<iframe width="500" height="250" name="existing" style="border:1px solid #CCC;" src="{% url ajax_browser object.get_absolute_url "image" %}" />' +
					'</div>' +
					'<input type="button" value="Submit"/>' + 
				'</div>';
		
			$.cleditor.buttons.link.popupContent = 
				'<ul class="browser-tabs nav tabs">' +
					'<li><a href="#link-url" data-toggle="tab">{% trans "External url" %}</a></li>' +								
					'<li><a href="#existing-url" data-toggle="tab">{% trans "Choose an existing object to link" %}</a></li>' +
				'</ul>' +
				'<div class="tab-content">' +
					'<div id="link-url" class="tab-pane fade">' +					
						'<input type="text" class="url" size="40" value="" />' +
					'</div>' +
					'<div id="existing-url" class="tab-pane fade">'+
						'<iframe width="500" height="250" name="existing" style="border:1px solid #CCC;" src="{% url ajax_browser object.get_absolute_url "all" %}" />' +
					'</div>' +
					'<input type="button" class="save-link" value="Submit"/>' +
				'</div>';
		</script>
	{% endif %}
{% endblock %}

{% block content %}
        {% block content_tabs %}
		<div class="content-tabs">
			<div class="navbar navbar-static">
				<div class="navbar-inner">
					<div class="container">
						<ul class="nav">
							<li class="active"><a href="#">{{ object.title }}</a></li>
						</ul>
						{% ifhasperm edit object %}
							{% include "cms/cms_admin_menu.html" with object=object %}
				        {% endifhasperm %}
					</div>
				</div>
			</div>
		</div>
        {% endblock %}


<div class="cms-breadcrumb">
	{% block cms_nav %}
		{% if ancestors|length == 0 %}
			<a href="/{{object.get_absolute_url}}" class="nextnav">{{object.title}}</a> <span class="current nextnav">{% trans "Homepage" %}</span>
		{% else %}
			{% for item in ancestors %}
				<a href="/{{item.get_absolute_url}}" class="nextnav">{{item}}</a> 
			{% endfor %}
			<span class="current nextnav">{{ object.title }}</span>
		{% endif %}
	{% endblock %}
</div>

<div class="row">
	<div class="span8">
		<div class="cms-content">
			{% block content_left %}{% endblock %}
		</div>
		{% if parent.portal_type == 'multipage' %}		
			<div class="cms-nav">
				{% with object.get_previous_sibling as previous %}
					{% if previous %}
						<a href="/{{ previous.get_absolute_url }}" class="prev">{{ previous }}</a>
					{% endif %}
				{% endwith %}
				{% with object.get_next_sibling as next %}
					{% if next %}
						<a href="/{{next.get_absolute_url }}" class="next">{{ next }}</a>
					{% endif %}
				{% endwith %}
			</div>		
		{% endif %}		
	</div>
	<div class="span4">
        <!-- <div class="tags-folder">{{object.tags}}</div> -->
		{% get_content_parent object %}
		{% if content_parent.parent.portal_type == 'course' %}
			{% load courses_tags %}
			{% get_user_section content_parent.parent %}
			{% if section %}
				{% show_navigation section %}
			{% endif %}
		{% else %}
			{% show_navigation object %}
		{% endif %}
		{% if parent.portal_type == 'multipage' %}
			<div class="widget multipage-toc">
				<div class="title">{% trans "Table Of Contents" %}</div>
				<div class="widget-content">
					<ul class="nav list">
						{% for item in parent.get_children %}
							<li {% if item.slug == object.slug %} class="active" {% endif %}><img src="{{ STATIC_URL }}images/cms-icons/{{item.portal_type}}.png" width="16" height="16" style="display: inline;"/><a href="/{{item.get_absolute_url}}">{{ item }}</a></li>
						{% endfor %}
					</ul>		
				</div>
			</div>
		{% endif %}		
		{% block content_right %}{% endblock %}
	</div>
</div>
<div class="modal fade hide" id="cms-confirm-modal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">Ã—</a>
    <h3>{% trans "Delete" %}</h3>
  </div>
  <div class="modal-body">
    <p>{% trans "Do you really want to delete the item" %}</p>
  </div>
  <div class="modal-footer">
	<form class="form" method="POST" action="">
	    {% csrf_token %}
	    <div class="form_block">
		    <input type="submit" class="btn primary" value="{% trans 'Confirm' %}" />
		    <a href="#" class="btn" data-dismiss="modal">Close</a>
	    </div>
	</form>
  </div>
</div>
{% endblock %}
